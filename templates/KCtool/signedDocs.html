{% extends 'base.html'%}
{% load customtags %}
{% load static %}
{% block content %}
<section>
    <div class="top_content">
        <div class="title_content">
            <p>Danh sách văn bản đã ký</p>
            <span class="number_vb">{{numbersendedpdfs}} văn bản</span>
        </div>
        <div class="btn_content">
            {% if user.is_signer or user.is_admin %}
            <button class="all-sign" > 
                <a href="#" onclick="send_all_pdf()">
                    <img src="{% static 'image/icon-email.png' %}" alt="email">
                Gửi mail tất cả
                </a>                
            </button>
            {% else %}
            <button class="all-sign" > 
                <a href="#" onclick="alert('Not allowed!!')">
                    <img src="{% static 'image/icon-email.png' %}" alt="email">
                Gửi mail tất cả
                </a>                
            </button>
            {% endif %}
            
        </div>
      
    </div>
      
    <form  action="{% url 'KCTool:signedDocs' %}?" method="GET" id="form">
        <div class="filter_content">
            <div class="filter_left">
                <div class="input-search">
                    <input type="search" placeholder="Tìm kiếm file"  id="key_word" name="key_word" value="{{ key_word }}">
                    <button type="submit"><i class="fa-solid fa-magnifying-glass"></i></button>
                </div>

            </div>
            <div class="filter_right">
                <div class="input-date pr-15">
                    <input type="date" id="fromdate" name="fromdate" value="{{ fromdate }}"> đến
                    <input type="date" id="todate" name="todate" value="{{ todate }}">
                    <button type="submit" id="search"class="btn-submit">Lọc</button>
                </div>
            </div>
        </div>
    </form>

    <div class="table_content">
        <table>
            <tr>
                <th>
                    <input type="checkbox" name="check_all" id="check_all" class="checkall">
                </th>
                <th width="10%"> <select id="account" 
                    style="
                    font-size:17px;
                    font-weight: 600; 
                    border: none;
                    outline: none;
                    border-radius: 4px;
                    background: #E6ECF4;" >
                        <option>Loại account</option>
                            {% for accounT in accountList %}
                            <option value="{{accounT}}"
                            {% if account == "{{accounT}}" %}
                                selected
                            {% endif %}>
                                {{accounT}}
                            </option>
                        {% endfor %}</th>
                <th width="10%">Danh mục</th>
                <th width="30%">Tên file</th>
                <th width="10%">Thời gian kí gửi</th> 
                <th width="10%">Trạng thái</th>
                <th width="20%">Email</th>
                <th width="5%">Xem file</th>
            </tr>
            <tr>
                {% for pdf in pdfs %}
                <td>
                    <input type="checkbox" name="check" value="{{pdf.pk}}" id="check" class="checkitem" group="pk_pdf_file">
                </td>
                <td value="{{pdf.account}}">{{pdf.account}}</td>
                <td>{{pdf.loaict}}</td>
                <td>{{pdf.slaveFile|subNameFileFilter}}</td>
                <td>{{pdf.sendingTime|date:"d/m/Y"}},{{pdf.sendingTime|time:"H:i"}}</td>
                {% if pdf.sended %}
                <td>{{pdf.sended|signedValue}}</td>
                {% else%}
                <td style="color:rgba(207, 7, 7, 0.779) ;font-weight: 900;">{{pdf.sended|signedValue}}</td>
                {% endif %}
                <td>{% for email in pdf.emailExtracted.all %}
                    {{email}}<hr>
                    {% endfor %}
                </td>
                
                
                
                
                
                <!-- <td>
                    <select name="" id="" class="select-status">
                        <option value=""></option>
                        <option value="Đã gửi" class="status-success">Đã gửi</option>
                        <option value="Chưa gửi" class="status-fail">Chưa gửi</option>
                    </select>
                </td> -->
                <td><a href="#viewPDF" id="{{URL}}/{{pdf.slaveFile}}" onclick="view_pdf_modal(this.id)"><img src="{% static 'image/document.png' %}" alt="document"></a></td>
            </tr>
                {% endfor %}
        </table>
    </div>
   
 </section>
 <footer>
    <div class="copy-right">
        <p>&copy; <a href="https://pvssolution.com">pvssolution.com</a></p>
    </div>
 </footer>

 <!-- Modal Info -->
 {% comment %} <div id="info" class="modal">
    <form action="/" method="post">
        {% csrf_token %}
        <div class="modal__content">
            <div class="modal__title">
                <img src="{% static 'image/UserList.png' %}" alt="UserList">
                <p>Thông tin tài khoản</p>          
            </div>

            <div class="modal__detail">
                <div class="user">
                    <span class="avarta_name">D</span>
                    <div class="info_name">
                        <p>Nguyễn Thanh Điền</p>
                        <small>User: 07/08/2022</small>
                    </div>
                </div>

                <div class="input_group">
                    <label for="full_name">
                        Họ và tên
                        <input type="text" name="full_name" placeholder="Họ và tên">
                    </label>
                    <label for="phone">
                        Số điện thoại
                        <input type="tel" id="numbPhone" name="phone" placeholder="909 999 999" >
                    </label>
                    <label for="email">
                        Email
                        <input type="email" name="email" placeholder="Nhập email" required>
                    </label>
                    <label for="passwd">
                        Mật khẩu
                        <div class="form-group has-feedback">
                            <input type="password" name="passwd" id="password" placeholder="Nhập mật khẩu">
                            <i class="showpass show-eye-open fas fa-eye"></i>
                          </div>
                    </label>
                </div>   
            </div>

            <div class="modal__title-child">
                <p>Thông tin công ty</p>          
            </div>
            <div class="modal__detail">
                <div class="input_group">
                    <label for="company_name">
                        Tên công ty
                        <input type="text" name="company_name" placeholder="Nhập tên công ty">
                    </label>
    
                    <label for="title_name">
                        Chức danh
                        <input type="text" name="title_name" placeholder="Nhập chức danh">
                    </label>
                    
                </div>   
            </div>
            <div class="modal__title-child">
                <p>Thông tin địa chỉ</p>          
            </div>
            <div class="modal__detail">
                <div class="input_group input_address">
                    <label for="company_address">
                        Địa chỉ
                        <input type="text" name="company_address" placeholder="Nhập thông tin địa chỉ">
                    </label>
                    
                </div>   
            </div>
            <div class="modal__footer">
                <button class="btn_cancel">Huỷ</button>
                <button class="btn_save">Lưu</button>
            </div>
            
            <a href="#" class="modal__close">&times;</a>
        </div>
    </form>
</div> {% endcomment %}
<!-- Modal Upload E-Sign -->
<div id="eSign" class="modal">
    <form action="/" method="post">
        {% csrf_token %}
        <div class="modal__content">
            <div class="modal__title">
                <img src="{% static 'image/vb-sign.png' %}" alt="vb-sign">
                <p>Thêm chữ ký</p>          
            </div>

            <div class="modal__detail">
                <div class="user">
                    <span class="avarta_name">D</span>
                    <div class="info_name">
                        <p>Nguyễn Thanh Điền</p>
                        <small>User: 07/08/2022</small>
                    </div>
                </div>

                <div class="input_group">
                    <div class="upload-btn-wrapper">
                        <button class="btn">Upload chữ ký số</button>
                        <input type="file" name="myfile" />
                    </div>
                </div>   
            </div>

            
            <div class="modal__footer">
                <button class="btn_cancel">Huỷ</button>
                <button class="btn_save">Lưu</button>
            </div>
            
            <a href="#" class="modal__close">&times;</a>
        </div>
    </form>
</div>
<div id="viewPDF" class="modal"  >
    
    <div class="modal__content">
        <div class="modal__title">
            <i class="fa-solid fa-file-pdf"></i>
            <p>View file</p>          
        </div>

        <div class="modal__detail">
            <span id="change_link_pdf">
             
            </span>
        </div>

        
        <div class="modal__footer">
            <a href="#" > <button class="btn_save">Xong</button></a>
        </div>
        <a href="#" class="modal__close">&times;</a>
       
    </div>

</div>

<script>
    function view_pdf_modal(id) {
        //alert(id)
        $("#change_link_pdf").html(`<embed src="${id}" width="1100" height="500" type="application/pdf">`)
    }
</script>
<script>
    function send_all_pdf(){
        var arr_pk_pdf_file = [];
        var postData = new FormData();
        $.each($("input:checkbox[group='pk_pdf_file']:checked"), function(i){
            arr_pk_pdf_file.push($(this).val());
        });
        alert(arr_pk_pdf_file)
        
        postData.append("list_id_pdf_file", arr_pk_pdf_file);
        var csrftoken = $("[name=csrfmiddlewaretoken]").val();
        $.ajax({
            type: "post",
            url: "{% url 'KCTool:send_pdf' %}",
            data: postData,
            cache: false,
            processData:false,
            contentType: false,
            headers:{
                "X-CSRFToken": csrftoken
            },
            
            success: function(resp) {
                alert(resp.log)
                window.location.replace(``);
            },
            error:function(xhr, status, error){            
              alert(xhr.responseText);
                //window.location.replace(``);
            }
        }) //end ajax
    }
   
</script> 
<script>
    $(document).ready(function() {
        $("#account").change(function() {
            var account = $("#account option:selected").val();
            var key_word = $("#key_word").val();
            var fromdate = $("#fromdate").val();
            var todate = $("#todate").val();
            var url = "{% url 'KCTool:signedDocs' %}?";
            if (account !== "Loại account") {
                url += "&account=" + account;
            }
            if (key_word !== "") {
                url += "&key_word=" + key_word;
            }
            if (fromdate !== "") {
                url += "&key_word=" + fromdate;
            }
            if (todate !== "") {
                url += "&key_word=" + todate;
            }        
            window.location.replace(url);
            // form.submit();
        });
    
        $("#search").click(function(){
            var account = $("#account option:selected").val();
            var key_word = $("#key_word").val();
            var fromdate = $("#fromdate").val();
            var todate = $("#todate").val();
    
            var url = "{% url 'KCTool:signedDocs' %}?";
            if (account !== "Loại account") {
                url += "&account=" + account;
            }
            if (key_word !== "") {
                url += "&key_word=" + key_word;
            }
            if (fromdate !== "") {
                url += "&key_word=" + fromdate;
            }
            if (todate !== "") {
                url += "&key_word=" + todate;
            }
            console.log(url);      
            window.location.replace(url);
        })
        
    }); // end ready
    </script>    

{% endblock %}